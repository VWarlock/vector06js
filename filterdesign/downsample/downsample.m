pkg load control
pkg load signal

clear all;
clf;

#f1 = 10000;
#f2 = 20000;
#delta_f = f2-f1;
#Fs = 1500000;
#dB  = 40;
#N = dB*Fs/(22*delta_f);
#f =  [f1 ]/(Fs/2);
#fir_filter = fir1(round(N)-1, f,'low');

#[butter_b,butter_a] = butter(8,12000/1.5e6);

#[butter_b,butter_a] = ellip(4,2,60,10000/1.5e6);
[butter_b,butter_a] = cheby2(2,40,55000/1.5e6);


#butter_b =[0.00042959026400046546, 0.0008591805280009309, 0.00042959026400046546]
#butter_a = [1,  -1.95726478891915, 0.9589831499751518]

raw=fopen("sound.raw", "rb");
[_rawdata,count]=fread(raw,Inf,"float32");

rawdata = _rawdata;
#rawdata = _rawdata(1:8192);
#rawdata = randn(8192,1);

vec = 0:1:8191;

freqs=fft(rawdata, length(vec));

#c_ws = [5.750052069805929e-7,0.0000016723011359876648,0.0000034426143466439983,0.000006049135326185442,0.000009663942288492983,0.000014463423242564008,0.000020622678831094828,0.00002830891649694063,0.00003767387744057352,0.000048845371553354955,0.00006191803081502458,0.00007694342831808595,0.00009391974667216987,0.00011278121602530976,0.00013338757574261664,0.00015551384584194,0.00017884072173947197,0.00020294592883620972,0.0002272968895001778,0.00025124506690345964,0.0002740223490979023,0.00029473983296148014,0.00031238935030766194,0.00032584805350933845,0.00033388634281526287,0.0003351793710773619,0.00032832231026521156,0.0003118494944754641,0.00028425748675601164,0.00024403203389845477,0.000189678787746031,0.00011975757996416575,0.000032919942470075386,-0.00007205053047830197,-0.00019619547830707575,-0.0003403373203250309,-0.0005050337340642572,-0.0006905318263482957,-0.000896722831508665,-0.0011230982304753793,-0.0013687082316194104,-0.0016321235857061482,-0.001911401721834939,-0.002204058187367003,-0.0025070443515032856,-0.0028167322886337204,-0.0031289076934910196,-0.003438771595565175,-0.0037409515356563072,-0.004029522746730851,-0.004298039719999572,-0.0045395784374430365,-0.004746789288245515,-0.004911960594193642,-0.00502709242668436,-0.005083980219553331,-0.005074307482880883,-0.004989746728408537,-0.004822067528656781,-0.004563250453098968,-0.0042056054596062865,-0.003741893171513575,-0.003165447343549277,-0.002470296716743805,-0.0016512843861511124,-0.0007041827582492796,0.0003741978407875231,0.0015859088276775118,0.0029317731665100344,0.004411307101549656,0.006022655486682061,0.0077625422291918555,0.009626237184083298,0.011607540625114751,0.01369878618299674,0.015890862883253296,0.01817325665415065,0.020534111288772812,0.02296030882657485,0.025437568561815643,0.027950564026062986,0.03048305673811726,0.03301804531428763,0.03553792825313119,0.03802467846347996,0.0404600273858515,0.04282565636943123,0.04510339281348128,0.047275408466466336,0.04932441720093474,0.05123386954909912,0.05298814129423447,0.05457271346678222,0.05597434119097061,0.05718120896659789,0.05818307014937805,0.05897136860917679,0.05953934079515777,0.059882096716251935,0.05999667864986272,0.059882096716251935,0.05953934079515777,0.05897136860917679,0.05818307014937805,0.05718120896659789,0.05597434119097061,0.05457271346678222,0.05298814129423447,0.05123386954909912,0.04932441720093474,0.047275408466466336,0.04510339281348128,0.04282565636943123,0.0404600273858515,0.03802467846347996,0.03553792825313119,0.03301804531428763,0.03048305673811726,0.027950564026062986,0.025437568561815643,0.02296030882657485,0.020534111288772812,0.01817325665415065,0.015890862883253296,0.01369878618299674,0.011607540625114751,0.009626237184083298,0.0077625422291918555,0.006022655486682061,0.004411307101549656,0.0029317731665100344,0.0015859088276775118,0.0003741978407875231,-0.0007041827582492796,-0.0016512843861511124,-0.002470296716743805,-0.003165447343549277,-0.003741893171513575,-0.0042056054596062865,-0.004563250453098968,-0.004822067528656781,-0.004989746728408537,-0.005074307482880883,-0.005083980219553331,-0.00502709242668436,-0.004911960594193642,-0.004746789288245515,-0.0045395784374430365,-0.004298039719999572,-0.004029522746730851,-0.0037409515356563072,-0.003438771595565175,-0.0031289076934910196,-0.0028167322886337204,-0.0025070443515032856,-0.002204058187367003,-0.001911401721834939,-0.0016321235857061482,-0.0013687082316194104,-0.0011230982304753793,-0.000896722831508665,-0.0006905318263482957,-0.0005050337340642572,-0.0003403373203250309,-0.00019619547830707575,-0.00007205053047830197,0.000032919942470075386,0.00011975757996416575,0.000189678787746031,0.00024403203389845477,0.00028425748675601164,0.0003118494944754641,0.00032832231026521156,0.0003351793710773619,0.00033388634281526287,0.00032584805350933845,0.00031238935030766194,0.00029473983296148014,0.0002740223490979023,0.00025124506690345964,0.0002272968895001778,0.00020294592883620972,0.00017884072173947197,0.00015551384584194,0.00013338757574261664,0.00011278121602530976,0.00009391974667216987,0.00007694342831808595,0.00006191803081502458,0.000048845371553354955,0.00003767387744057352,0.00002830891649694063,0.000020622678831094828,0.000014463423242564008,0.000009663942288492983,0.000006049135326185442,0.0000034426143466439983,0.0000016723011359876648,5.750052069805929e-7];
#c_ws = hc;
#[AR, PR] = freqz(c_ws);
[AR, PR] = freqz(butter_b, butter_a);
subplot(2,2,1);
plot(PR,mag2db(abs(AR)));
ylabel("Mag(dB)");
title("Fitler");
filtered = filter(butter_b,butter_a,rawdata);
#filtered = filter(butter_b,butter_a,filtered);
freqs_filtered = fft(filtered, length(vec));

subplot (2,2,2);
fs_orig=1.5e6;
freqrange = 1:fs_orig/4096:fs_orig;
#freqrange = 1:44100/4096:44100;
plot(freqrange, mag2db(abs(freqs(1:4096))), "color", [1,0.6,0.6], freqrange, mag2db(abs(freqs_filtered(1:4096))));
title("Raw vs Filtered signal");

k = 1;
fac = 44100/1.5e6;
accu = 0;
decimated = [];
for i = 1:length(filtered)
  accu = accu + fac;
  if accu > 1.0
    accu = accu - 1.0;
    decimated(k) = filtered(i);
    k = k + 1;
  endif
endfor

freqs_result = fft(decimated, length(vec));
subplot(2,2,4);
plot(1:44100/4096:44100, mag2db(abs(freqs_result(1:4096))));
title("Downsampled signal");


player=audioplayer(decimated*(1/max(decimated)),44100,16);
play(player);